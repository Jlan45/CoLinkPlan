# 产品需求文档 (PRD) - Co-Link Plan 服务端 (Orchestrator)

## 1. 产品概述
**Co-Link Plan Server** 是一个分布式 AI 算力代理网关。它的核心职责是接收标准 OpenAI SDK 格式的调用请求，通过内部的路由调度算法，将请求通过 WebSocket 透明下发至处于空闲状态的本地客户端，并将客户端流式返回的结果传回给调用者。服务端不保存任何 AI 生成的明文数据，仅作为连接桥梁与鉴权中心。

## 2. 核心技术栈
* **开发语言:** Go 1.24+ (利用 Goroutine 处理高并发长连接)
* **核心框架:** Gin (HTTP/API)、Gorilla WebSocket (长连接)
* **数据存储:** PostgreSQL (持久化配置与凭证)、Redis (Token 令牌桶限流与高频状态缓存)

## 3. 核心功能需求

### 3.1 鉴权与流控管理 (API Gateway)
* **密钥生成:** 管理员可通过控制台生成 `sk-colink-xxxx` 格式的 API Key。
* **访问控制:** 支持为每个 API Key 配置可用模型列表 (如仅允许使用 `gpt-3.5-turbo`)。
* **速率限制 (Rate Limit):** 基于 Redis 令牌桶算法，对调用者 API Key 实施 RPM (每分钟请求数) 限制。若超限则返回 `HTTP 429 Too Many Requests`。

### 3.2 WebSocket 调度中心 (WS Hub)
* **客户端握手:** 校验客户端连接时 Header 中携带的 `Client-Token`，合法则建立全双工长连接。
* **心跳保活:** 服务端每 15 秒下发 `Ping`，客户端需在 5 秒内回复 `Pong`。连续 3 次无响应则强行断开并剔除出可用路由池。
* **状态同步:** 实时监听客户端上报的并发状态和可用模型列表。

### 3.3 智能路由与故障转移 (Scheduler & Failover)
* **负载均衡:** 采用 **“最少活动请求优先 (Least Active Requests)”** 算法。从支持目标模型的客户端池中，挑选当前 `Active_Task / Max_Parallel` 比例最低的客户端下发任务。
* **静默重试:** 1. 若选中的客户端连接突然断开，或返回非业务性错误 (如 401 密钥失效、429 上游风控)。
    2. 服务端拦截该错误，**不切断**与调用者的 HTTP 响应流。
    3. 服务端在可用池中寻找下一个客户端进行重试 (最高重试 3 次)。
* **节点降权:** 发生错误的客户端，在接下来的 60 秒内降低其路由权重，减少派单频率。

### 4. 接口协议规约
* **对外 API (调用者):** 100% 兼容 `POST /v1/chat/completions` 标准。
* **对内 WS (客户端):** 采用 JSON 格式进行指令通信：
    * `REGISTER`: 客户端注册可用模型与最大并发数。
    * `CALL`: 服务端下发对话 Prompt。
    * `STREAM`: 客户端回传 SSE 数据块。
    * `ERROR` / `FINISH`: 异常终止或正常结束。